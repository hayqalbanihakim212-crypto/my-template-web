<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - GOD'S PLAN</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="00.css">
</head>
<body>
    
    <!-- Navbar Sederhana -->
    <nav class="navbar navbar-expand-lg bg-danger fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="0.html"><i class="fa-solid fa-arrow-left me-2"></i> Kembali ke Home</a>
            <span class="navbar-text text-white fw-bold">Admin Dashboard</span>
        </div>
    </nav>

    <div class="container admin-container">
        
        <!-- Login Section -->
        <div id="loginSection" class="card shadow-lg border-0 p-4" style="max-width: 400px; width: 100%; background: #16213e; color: white;">
            <h3 class="text-center mb-4" style="color: #ef5350;">Admin Login</h3>
            <form onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="adminPass" class="form-control" placeholder="Masukkan password admin" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-danger">Masuk</button>
                </div>
                <p id="errorMsg" class="text-danger text-center mt-3" style="display: none;">Password Salah!</p>
            </form>
        </div>

        <!-- Data Section (Hidden by default) -->
        <div id="dataSection" style="display: none; width: 100%;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-white">Data Pendaftar</h2>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-dark-custom">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nama Lengkap</th>
                            <th>WhatsApp</th>
                            <th>Tanggal Daftar</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data akan diisi via JS -->
                    </tbody>
                </table>
            </div>
            <div id="emptyMsg" class="text-center text-secondary mt-4" style="display: none;">Belum ada data pendaftar.</div>
        </div>

        <!-- Upload Module Section (Hidden by default) -->
        <div id="uploadSection" class="card shadow-lg border-0 p-4 mt-5" style="display: none; width: 100%; background: #16213e; color: white;">
            <h3 class="text-center mb-4" style="color: #ef5350;">Upload Modul Baru</h3>
            
            <!-- Tabel Daftar Modul -->
            <h5 class="text-white mt-4">Daftar Modul Aktif</h5>
            <div class="table-responsive mb-4">
                <table class="table table-dark-custom table-sm">
                    <thead>
                        <tr>
                            <th>Judul</th>
                            <th>File</th>
                            <th>Premium</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="modulesTableBody">
                        <!-- Data Modul -->
                    </tbody>
                </table>
            </div>

            <!-- Form Upload -->
            <form onsubmit="handleUpload(event)">
                <div class="mb-3">
                    <label class="form-label">Judul Modul</label>
                    <input type="text" id="modTitle" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Deskripsi</label>
                    <textarea id="modDesc" class="form-control" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">File Modul</label>
                    <input type="file" id="modFile" class="form-control" required>
                </div>
                
                <!-- Fitur Premium -->
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="isPremium" onchange="togglePasswordInput()">
                    <label class="form-check-label" for="isPremium">File Premium (Perlu Password)</label>
                </div>
                <div class="mb-3" id="passwordField" style="display: none;">
                    <label class="form-label">Password Akses</label>
                    <input type="text" id="filePassword" class="form-control" placeholder="Masukkan password untuk download">
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-success">
                        <i class="fa-solid fa-upload me-2"></i> Upload
                    </button>
                </div>
            </form>
        </div>

        <!-- Post Trade History Section (Hidden by default) -->
        <div id="postTradeSection" class="card shadow-lg border-0 p-4 mt-5" style="display: none; width: 100%; background: #16213e; color: white;">
            <h3 class="text-center mb-4" style="color: #ef5350;">Upload Riwayat Trade</h3>
            
            <h5 class="text-white mt-4">Daftar Trade Aktif</h5>
            <div class="table-responsive mb-4">
                <table class="table table-dark-custom table-sm">
                    <thead>
                        <tr>
                            <th>Pair</th>
                            <th>Result</th>
                            <th>Tanggal</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody"></tbody>
                </table>
            </div>

            <form onsubmit="handlePostTrade(event)">
                <div class="mb-3">
                    <label class="form-label">Pair (Contoh: XAUUSD)</label>
                    <input type="text" id="tradePair" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Hasil (Contoh: +50 Pips / Win)</label>
                    <input type="text" id="tradeResult" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Deskripsi Singkat</label>
                    <textarea id="tradeDesc" class="form-control" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Screenshot Chart</label>
                    <input type="file" id="tradeImage" class="form-control" accept="image/*" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-chart-line me-2"></i> Posting Trade
                    </button>
                </div>
            </form>
        </div>

        <!-- Post Update Komunitas Section (Hidden by default) -->
        <div id="postUpdateSection" class="card shadow-lg border-0 p-4 mt-5 mb-5" style="display: none; width: 100%; background: #16213e; color: white;">
            <h3 class="text-center mb-4" style="color: #ef5350;">Post Update Komunitas</h3>
            
            <!-- Tabel Daftar Update -->
            <h5 class="text-white mt-4">Daftar Update Aktif</h5>
            <div class="table-responsive mb-4">
                <table class="table table-dark-custom table-sm">
                    <thead>
                        <tr>
                            <th>Judul</th>
                            <th>Tanggal</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="updatesTableBody">
                        <!-- Data Update -->
                    </tbody>
                </table>
            </div>

            <form onsubmit="handlePostUpdate(event)">
                <div class="mb-3">
                    <label class="form-label">Judul Berita/Update</label>
                    <input type="text" id="updTitle" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Deskripsi Singkat</label>
                    <textarea id="updDesc" class="form-control" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Gambar Utama</label>
                    <input type="file" id="updImage" class="form-control" accept="image/*" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-paper-plane me-2"></i> Posting Update
                    </button>
                </div>
            </form>
        </div>

    </div>

    <script>
        let sessionPassword = '';

        // Cek sesi login saat halaman dimuat (Auto Login jika refresh)
        document.addEventListener('DOMContentLoaded', () => {
            const savedPassword = sessionStorage.getItem('adminSession');
            if (savedPassword) {
                document.getElementById('adminPass').value = savedPassword;
                handleLogin(null, savedPassword);
            }
        });

        async function handleLogin(e, autoPassword = null) {
            if (e) e.preventDefault();
            const password = autoPassword || document.getElementById('adminPass').value;
            const errorMsg = document.getElementById('errorMsg');
            const btn = document.querySelector('#loginSection button');

            btn.disabled = true;
            btn.innerText = 'Memeriksa...';

            try {
                const response = await fetch('http://localhost:3000/api/admin/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();

                if (result.success) {
                    // Login Berhasil
                    sessionPassword = password;
                    sessionStorage.setItem('adminSession', password); // Simpan sesi agar tahan refresh
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('dataSection').style.display = 'block';
                    document.getElementById('uploadSection').style.display = 'block';
                    document.getElementById('postUpdateSection').style.display = 'block';
                    document.getElementById('postTradeSection').style.display = 'block';
                    renderTable(result.data);
                    loadModulesList(); // Load daftar modul
                    loadUpdatesList(); // Load daftar update
                    loadTradesList();  // Load daftar trade
                } else {
                    // Login Gagal
                    errorMsg.style.display = 'block';
                    sessionStorage.removeItem('adminSession');
                }
            } catch (err) {
                console.error(err);
                if (e) alert('Gagal terhubung ke server. Pastikan server.js berjalan.');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Masuk';
            }
        }

        async function loadData() {
            try {
                const response = await fetch('http://localhost:3000/api/admin/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: sessionPassword })
                });
                const result = await response.json();
                if (result.success) {
                    renderTable(result.data);
                }
            } catch (err) {
                console.error(err);
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('emptyMsg').style.display = 'block';
                return;
            }

            data.forEach((user, index) => {
                const date = new Date(user.date).toLocaleString('id-ID');
                const safeWa = encodeURIComponent(user.wa).replace(/'/g, "%27");
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="fw-bold text-white">${user.name}</td>
                        <td>
                            <a href="https://wa.me/${user.wa}" target="_blank" class="text-decoration-none text-success">
                                <i class="fa-brands fa-whatsapp"></i> ${user.wa}
                            </a>
                        </td>
                        <td>${date}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser('${safeWa}')">
                                <i class="fa-solid fa-trash"></i> Hapus
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function logout() {
            sessionStorage.removeItem('adminSession'); // Hapus sesi saat logout
            location.reload();
        }

        async function deleteUser(encodedWa) {
            if (!confirm('Apakah Anda yakin ingin menghapus data pendaftar ini?')) return;

            const wa = decodeURIComponent(encodedWa);

            try {
                const response = await fetch('http://localhost:3000/api/admin/delete', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: sessionPassword, wa })
                });

                if (!response.ok) throw new Error(`Server Error: ${response.status}`);

                const result = await response.json();

                if (result.success) {
                    alert('Data berhasil dihapus');
                    // Refresh data tabel otomatis
                    loadData();
                } else {
                    alert('Gagal menghapus: ' + result.message);
                }
            } catch (err) {
                console.error(err);
                alert('Gagal: ' + err.message);
            }
        }

        function togglePasswordInput() {
            const isChecked = document.getElementById('isPremium').checked;
            document.getElementById('passwordField').style.display = isChecked ? 'block' : 'none';
        }

        async function handleUpload(e) {
            e.preventDefault();
            const title = document.getElementById('modTitle').value;
            const desc = document.getElementById('modDesc').value;
            const fileInput = document.getElementById('modFile');
            const file = fileInput.files[0];
            const isPremium = document.getElementById('isPremium').checked;
            const filePassword = document.getElementById('filePassword').value;

            const formData = new FormData();
            formData.append('password', sessionPassword);
            // Kirim data teks SEBELUM file untuk memastikan terbaca oleh Multer
            formData.append('title', title);
            formData.append('description', desc);
            formData.append('isPremium', isPremium);
            if(isPremium) formData.append('filePassword', filePassword);
            formData.append('file', file);

            try {
                const response = await fetch('http://localhost:3000/api/admin/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    e.target.reset(); // Reset form
                    loadModulesList(); // Refresh tabel
                }
            } catch (err) {
                console.error(err);
                alert('Gagal upload file. Cek koneksi server.');
            }
        }

        // --- Fungsi Load & Hapus Modul/Update ---

        async function loadModulesList() {
            const res = await fetch('http://localhost:3000/api/modules');
            const data = await res.json();
            const tbody = document.getElementById('modulesTableBody');
            tbody.innerHTML = '';
            data.forEach(m => {
                
                // FIX: encodeURIComponent tidak mengenkripsi tanda kutip ('), jadi harus replace manual
                const safeFilename = m.file ? encodeURIComponent(m.file).replace(/'/g, "%27") : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${m.title}</td>
                        <td>${m.file || '-'}</td>
                        <td>${m.isPremium ? '<span class="badge bg-warning text-dark">Premium</span>' : 'Gratis'}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteModule('${safeFilename}')"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
            });
        }

        async function deleteModule(encodedFilename) {
            if(!confirm('Hapus modul ini?')) return;
            let filename;
            try {
                filename = decodeURIComponent(encodedFilename); // Decode kembali nama file
            } catch (e) {
                return alert('Gagal: Nama file tidak valid atau rusak.');
            }
            if (!filename) return alert('Gagal: Nama file tidak valid.');

             console.log("Mencoba menghapus modul:", filename); // Debugging
            try {
                const res = await fetch('http://localhost:3000/api/admin/modules', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: sessionPassword, filename })
                });
                
                if (!res.ok) throw new Error(`Server Error: ${res.status}`);

                const result = await res.json();
                if (result.success) {
                    alert('Modul berhasil dihapus');
                    loadModulesList();
                } else {
                    alert('Gagal menghapus: ' + result.message);
                }
            } catch (err) {
                console.error(err);
                alert('Gagal: ' + err.message);
            }
        }

        async function loadUpdatesList() {
            const res = await fetch('http://localhost:3000/api/updates');
            const data = await res.json();
            const tbody = document.getElementById('updatesTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-secondary">Belum ada update komunitas.</td></tr>';
                return;
            }

            data.forEach(u => {
                const date = new Date(u.date).toLocaleDateString('id-ID');
                // FIX: encodeURIComponent tidak mengenkripsi tanda kutip ('), jadi harus replace manual
                const safeImage = u.image ? encodeURIComponent(u.image).replace(/'/g, "%27") : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${u.title}</td>
                        <td>${date}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteUpdate('${safeImage}')"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
            });
        }

        async function deleteUpdate(encodedImage) {
            if(!confirm('Hapus update ini?')) return;
            const image = decodeURIComponent(encodedImage); // Decode kembali nama file
            if (!image) return alert('Gagal: Data gambar tidak valid atau kosong.');
            try {
                const res = await fetch('http://localhost:3000/api/admin/updates', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: sessionPassword, image })
                });

                if (!res.ok) throw new Error(`Server Error: ${res.status}`);

                const result = await res.json();
                if (result.success) {
                    alert('Update berhasil dihapus');
                    loadUpdatesList();
                } else {
                    alert('Gagal menghapus: ' + result.message);
                }
            } catch (err) {
                console.error(err);
                alert('Gagal: ' + err.message);
            }
        }

        // --- Fungsi Load & Hapus Trade ---
        async function loadTradesList() {
            const res = await fetch('http://localhost:3000/api/trades');
            const data = await res.json();
            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-secondary">Belum ada riwayat trade.</td></tr>';
                return;
            }
            data.forEach(t => {
                const date = new Date(t.date).toLocaleDateString('id-ID');
                const safeImage = t.image ? encodeURIComponent(t.image).replace(/'/g, "%27") : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${t.pair}</td>
                        <td>${t.result}</td>
                        <td>${date}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteTrade('${safeImage}')"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
            });
        }

        async function handlePostTrade(e) {
            e.preventDefault();
            const pair = document.getElementById('tradePair').value;
            const resultVal = document.getElementById('tradeResult').value;
            const desc = document.getElementById('tradeDesc').value;
            const file = document.getElementById('tradeImage').files[0];

            const formData = new FormData();
            formData.append('password', sessionPassword);
            formData.append('pair', pair);
            formData.append('result', resultVal);
            formData.append('description', desc);
            formData.append('image', file);

            try {
                const res = await fetch('http://localhost:3000/api/admin/trades', { method: 'POST', body: formData });
                const json = await res.json();
                alert(json.message);
                if (json.success) { e.target.reset(); loadTradesList(); }
            } catch (err) { alert('Gagal posting trade.'); }
        }

        async function deleteTrade(encodedImage) {
            if(!confirm('Hapus trade ini?')) return;
            const image = decodeURIComponent(encodedImage);
            try {
                const res = await fetch('http://localhost:3000/api/admin/trades', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: sessionPassword, image })
                });
                const json = await res.json();
                if (json.success) { alert('Trade dihapus'); loadTradesList(); }
                else alert('Gagal: ' + json.message);
            } catch (err) { alert('Error koneksi.'); }
        }

        // Tambahkan penanganan error di handlePostUpdate agar alert muncul
        // (Timpa fungsi lama Anda dengan ini)
        async function handlePostUpdate(e) {
            e.preventDefault();
            const title = document.getElementById('updTitle').value;
            const desc = document.getElementById('updDesc').value;
            const fileInput = document.getElementById('updImage');
            const file = fileInput.files[0];

            const formData = new FormData();
            formData.append('password', sessionPassword);
            formData.append('title', title);
            formData.append('description', desc);
            formData.append('image', file);

            try {
                const response = await fetch('http://localhost:3000/api/admin/updates', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    e.target.reset();
                    loadUpdatesList();
                } else {
                    alert('Gagal: ' + result.message);
                }
            } catch (err) {
                console.error("Error posting update:", err);
                alert('Gagal memposting update (Koneksi Error).');
            }
        }
    </script>
</body>
</html>